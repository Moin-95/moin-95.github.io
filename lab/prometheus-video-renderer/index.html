<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Arthur Picerna" /><link rel="canonical" href="https://docs.ar2pi.net/lab/prometheus-video-renderer/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Prometheus Video Renderer - ar2pi</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Prometheus Video Renderer";
        var mkdocs_page_input_path = "lab/prometheus-video-renderer.md";
        var mkdocs_page_url = "/lab/prometheus-video-renderer/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> ar2pi
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../..">Arthur Picerna (ar2pi)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cheatsheets</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../go/">Go</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../python/">Python</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../shell/">Shell</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../vim/">Vim</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../git/">Git</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../networking/">Networking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../kubernetes/">Kubernetes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../linux-debian/">Linux (Debian)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Lab</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Prometheus Video Renderer</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#what-well-do">What we'll do</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-we-do-it">How we do it</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#install-dependencies">Install dependencies</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#setup-project">Setup project</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#convert-video-to-metrics">Convert video to metrics</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#backfill-metrics-into-prometheus">Backfill metrics into Prometheus</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#visualize-output">Visualize output</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#render-frames-through-grafana">Render frames through Grafana</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#merge-everything-back-into-a-video">Merge everything back into a video</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#resources">Resources</a>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">ar2pi</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
          <li>Lab &raquo;</li>
      <li class="breadcrumb-item active">Prometheus Video Renderer</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/ar2pi/ar2pi/edit/main/docs/lab/prometheus-video-renderer.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="prometheus-video-renderer">Prometheus video renderer</h1>
<h2 id="what-well-do">What we'll do</h2>
<p>Render videos in Grafana through Prometheus metrics.<br />
<a href="https://github.com/MacroPower/prometheus_video_renderer">MacroPower/prometheus_video_renderer</a></p>
<h2 id="how-we-do-it">How we do it</h2>
<h3 id="install-dependencies">Install dependencies</h3>
<pre><code class="language-sh">brew install golang ffmpeg jsonnet-bundler
</code></pre>
<pre><code class="language-sh">cat &lt;&lt;EOF &gt;&gt; ~/.zshrc 
# go
export GOPATH=$HOME/go
export GOBIN=$HOME/go/bin
export PATH=$PATH:$GOBIN
EOF

source ~/.zshrc 
</code></pre>
<pre><code class="language-sh">go get github.com/bwplotka/bingo
</code></pre>
<h3 id="setup-project">Setup project</h3>
<pre><code class="language-sh">git clone git@github.com:MacroPower/prometheus_video_renderer.git
cd prometheus_video_renderer

bingo get -v
(cd grafana; jb install)

mkdir data

docker compose up
</code></pre>
<pre><code class="language-sh">make dashboards
</code></pre>
<h3 id="convert-video-to-metrics">Convert video to metrics</h3>
<p>We'll be using <a href="https://www.youtube.com/watch?v=QH2-TGUlwu4">Nyan Cat original video</a> for obvious reasons. Go ahead and download, name it <code>nyan_cat.mp4</code> and place the file in the project folder.</p>
<pre><code class="language-sh">mkdir -p frames/nyan_cat
ffmpeg -i 'nyan_cat.mp4' -vf 'scale=150:100' -vsync 0 'frames/nyan_cat/out%06d.png'

mkdir -p metrics/nyan_cat
ulimit -n 8192
prometheus_video_renderer --project nyan_cat --mode rgb --start-time 1628640000000 # 11-08-2021 00:00:00
</code></pre>
<h3 id="backfill-metrics-into-prometheus">Backfill metrics into Prometheus</h3>
<pre><code class="language-sh">scripts/load.sh nyan_cat
</code></pre>
<h3 id="visualize-output">Visualize output</h3>
<p>Go to <a href="http://localhost:3000/d/pvr-dash-8-rgb/prometheus-video-renderer-8-0?orgId=1&amp;from=1628675100000&amp;to=1628675400000">http://localhost:3000/d/pvr-dash-8-rgb/prometheus-video-renderer-8-0?orgId=1&amp;from=1628675100000&amp;to=1628675400000</a>
<img alt="image" src="../../images/nyan_cat.png" /></p>
<p>Go to <a href="http://localhost:8081/render?deviceScaleFactor=1.000000&amp;domain=localhost&amp;encoding=&amp;height=1080&amp;renderKey=TljYdA5Bp7IEU7D7rasBnwc6my7mu5hW&amp;timeout=59&amp;timezone=&amp;url=http://grafana:3000/d/pvr-dash-8-rgb?from%3D1628675100000%26height%3D1080%26timeout%3D59%26to%3D1628675400000%26width%3D1920%26render%3D1&amp;width=1920">http://localhost:8081/render?deviceScaleFactor=1.000000&amp;domain=localhost&amp;encoding=&amp;height=1080&amp;renderKey=TljYdA5Bp7IEU7D7rasBnwc6my7mu5hW&amp;timeout=59&amp;timezone=&amp;url=http://grafana:3000/d/pvr-dash-8-rgb?from%3D1628675100000%26height%3D1080%26timeout%3D59%26to%3D1628675400000%26width%3D1920%26render%3D1&amp;width=1920</a>
<img alt="image" src="../../images/nyan_cat_rendered.png" /></p>
<h3 id="render-frames-through-grafana">Render frames through Grafana</h3>
<pre><code class="language-sh">mkdir -p frames/nyan_cat/rendered/video

grafana-image-renderer-cli sequence \
    --api-url=http://localhost:3000 \
    --api-key-or-basic-auth=admin:admin \
    --dashboard=pvr-dash-8-rgb \
    --start-time=1628675099640 \
    --frame-interval=5m \
    --out-directory=frames/nyan_cat/rendered \
    --frames=1-500
</code></pre>
<h3 id="merge-everything-back-into-a-video">Merge everything back into a video</h3>
<p>Now trim your original video to the portion of the video rendered if needed so that the audio can be merged with output. </p>
<pre><code class="language-sh">cd frames/nyan_cat/rendered

ffmpeg -framerate 30 -i '%06d.png' \
    -i ../../../nyan_cat_trimmed.mp4 -c copy -map 0:0 -map 1:1 -c:v libx264rgb -pix_fmt rgb24 -preset veryslow -crf 0 -qp 0 \
    video/grafanyan_cat.mp4
</code></pre>
<p>Open <code>video/grafanyan_cat.mp4</code> and enjoy ^_^</p>
<p>Example output:</p>
<p>
  <iframe width="560" height="315" src="https://www.youtube.com/embed/vvJUK9HOKQU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://grafana.com/blog/2021/07/30/how-to-use-grafana-and-prometheus-to-rickroll-your-friends-or-enemies/">https://grafana.com/blog/2021/07/30/how-to-use-grafana-and-prometheus-to-rickroll-your-friends-or-enemies/</a></li>
<li><a href="https://giedrius.blog/2019/09/21/is-it-a-good-idea-to-use-prometheus-for-storing-ascii-paintings/">https://giedrius.blog/2019/09/21/is-it-a-good-idea-to-use-prometheus-for-storing-ascii-paintings/</a></li>
<li><a href="https://github.com/MacroPower/grafana-image-renderer-sdk-go">https://github.com/MacroPower/grafana-image-renderer-sdk-go</a></li>
<li><a href="https://github.com/grafana/grafana-image-renderer">https://github.com/grafana/grafana-image-renderer</a></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../linux-debian/" class="btn btn-neutral float-left" title="Linux (Debian)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/ar2pi/ar2pi/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../linux-debian/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
